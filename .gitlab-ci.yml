---
default:
  interruptible: true

stages:
  - install
  - build
  - test
  - publish
  - docs
  - postpublish

variables:
  NODE_VERSION: 24-alpine
  NODE_PACKAGE_MANAGER: pnpm
  NODE_LINT_COMMAND: lint
  NODE_TEST_COMMAND: test
  NODE_INSTALL_ARGS: --ignore-scripts
  SEMANTIC_RELEASE_WORKSPACE: 'true'
  GITHUB_STATUS_PROJECT: listr2/listr2
  SKIP_SIMPLE_GIT_HOOKS: '1'

include:
  - project: devops/pipes
    file: /templates/node.gitlab-ci.yml

  - project: devops/pipes
    file: /templates/v2/node-run.gitlab-ci.yml

  - project: devops/pipes
    file: /templates/v2/semantic-release.gitlab-ci.yml

  - project: devops/pipes
    file: /templates/v2/docker-build-internal.gitlab-ci.yml

  - project: devops/pipes
    file: /templates/v2/github-status.gitlab-ci.yml

test:
  stage: test
  parallel:
    matrix:
      # TODO: tests are not reliable with node24 for now, check again with LTS
      # - NODE_VERSION: 24-alpine
      - NODE_VERSION: 22-alpine
      - NODE_VERSION: 20-alpine

semantic-release:
  stage: publish
  extends: .semantic-release
  needs:
    - build
    - lint
    - test
  dependencies:
    - build

build-docs:
  stage: docs
  extends: .node-run
  # this is buged out gitlab-ci with symlink fails
  before_script:
    - apk update
    - apk add git
    - pnpm i
  variables:
    NODE_COMMAND_SCRIPT: docs:build
    NODE_COMMAND_CWD: ./docs
  artifacts:
    paths:
      - ./docs/dist
  needs:
    # - install
    - build
    - semantic-release
  dependencies:
    # - install
    - build
    - semantic-release
  only:
    refs:
      - master
      - next
      - next-major
      - alpha
      - beta
      - rc

docker-build-docs:
  stage: postpublish
  extends: .docker-build-internal
  variables:
    DOCKERFILE_NAME: Dockerfile
    DOCKERFILE_CONTEXT: ./docs
    DOCKER_IMAGE_INTERNAL_NAME: docs-listr2
    DOCKER_IMAGE_TAGS: latest
  needs:
    - build-docs
  dependencies:
    - build-docs
  only:
    refs:
      - master
      - next
      - next-major
      - alpha
      - beta
      - rc
